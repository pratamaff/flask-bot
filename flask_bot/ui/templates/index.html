<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bot Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f8f9fa;
    }

    .card {
      border-radius: 12px;
    }

    .table td, .table th {
      vertical-align: middle;
    }

    .action-btns button,
    .action-btns form {
      margin-right: 4px;
    }
  </style>
</head>

<body class="p-4">

<div class="container">

  <h2 class="mb-1">Dashboard</h2>
  <p class="text-muted mb-4">
    Kelola trigger & response bot. Klik <b>Edit</b> untuk ubah langsung di tabel.
  </p>

  <!-- FLASH -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, msg in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ msg }}
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endwith %}

  <!-- ADD -->
  <div class="card mb-4">
    <div class="card-body">
      <form action="{{ url_for('add_trigger') }}" method="POST" class="row g-2">
        <div class="col-md-4">
          <input class="form-control" name="trigger" placeholder="Trigger (contoh: bagaimana cara ijin cuti?)" required>
        </div>
        <div class="col-md-6">
          <input class="form-control" name="response" placeholder="response (contoh :bisa dengan resep dokter maks ijin sesuai resep dokter)"required>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">Tambah</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:60px">No</th>
            <th>Trigger</th>
            <th>Response</th>
            <th style="width:180px">Aksi</th>
          </tr>
        </thead>
        <tbody>

        {% for t in triggers %}
        <tr data-id="{{ t.id }}">

          <td>{{ loop.index }}</td>

          <!-- VIEW MODE -->
          <td class="view trigger-text">{{ t.trigger }}</td>
          <td class="view response-text">{{ t.response }}</td>

          <!-- EDIT MODE -->
          <td class="edit d-none">
            <input class="form-control form-control-sm edit-trigger" value="{{ t.trigger }}">
          </td>
          <td class="edit d-none">
            <input class="form-control form-control-sm edit-response" value="{{ t.response }}">
          </td>

          <!-- ACTIONS -->
          <td class="action-btns">

            <!-- VIEW -->
            <button class="btn btn-sm btn-warning view edit-btn">‚úèÔ∏è Edit</button>

            <form action="{{ url_for('delete_trigger', id=t.id) }}"
                  method="POST"
                  class="d-inline view delete-form"
                  onsubmit="return confirm('Hapus trigger ini?')">
              <button class="btn btn-sm btn-danger">üóëÔ∏è Hapus</button>
            </form>

            <!-- EDIT -->
            <form action="{{ url_for('edit_trigger', id=t.id) }}"
                  method="POST"
                  class="d-inline edit d-none">

              <input type="hidden" name="trigger">
              <input type="hidden" name="response">

              <button class="btn btn-sm btn-success save-btn">üíæ Simpan</button>
              <button type="button" class="btn btn-sm btn-secondary cancel-btn">Batal</button>
            </form>

          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center text-muted py-4">
            Belum ada trigger
          </td>
        </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- JS -->
<script>
document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.onclick = () => {
    const tr = btn.closest("tr")

    // hide view elements (termasuk tombol hapus)
    tr.querySelectorAll(".view").forEach(e => e.classList.add("d-none"))

    // show edit elements
    tr.querySelectorAll(".edit").forEach(e => e.classList.remove("d-none"))
  }
})

document.querySelectorAll(".cancel-btn").forEach(btn => {
  btn.onclick = () => location.reload()
})

document.querySelectorAll(".save-btn").forEach(btn => {
  btn.onclick = () => {
    const tr = btn.closest("tr")
    const form = btn.closest("form")

    form.trigger.value = tr.querySelector(".edit-trigger").value
    form.response.value = tr.querySelector(".edit-response").value
  }
})
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
